<!DOCTYPE html>
<html lang="en">

<head>
    <title>TodoTasks.xyz</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"
        integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"
        integrity="sha512-57oZ/vW8ANMjR/KQ6Be9v/+/h6bq9/l3f0Oc7vn6qMqyhvPd1cvKBRWWpzu0QoneImqr2SkmO4MSqU+RpHom3Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.1/dist/web3.min.js"
        integrity="sha256-cdcyjItaOZqsMpqD2GtRBYwB4OBBT8RXfav8ecUYxtg=" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/argon2-browser/1.18.0/argon2-bundled.min.js"
        integrity="sha512-Alrh8vbmKDc5xiq7I/y8LTDwy9nw1nT9S/yR73HMMoWrpX4S1kizNPdWM896c/CDIGILNwAiaih627A94kRhYQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"
        integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"
        integrity="sha512-wT7uPE7tOP6w4o28u1DN775jYjHQApdBnib5Pho4RB0Pgd9y7eSkAV1BTqQydupYDB9GBhTcQQzyNMPMV3cAew=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="/bundle.js"></script>

    <style>
        .task_title_cell {
            width: 100%;
            padding-left: 10px;
        }

        .task_strikethrough {
            text-decoration: line-through;
        }

        .task_row:hover {
            background-color: rgb(246, 246, 246);
        }

        #open_tasks_table {
            width: 100%;
        }

        #completed_tasks_table {
            width: 100%;
        }
    </style>
</head>

<body>

    <script>
        var sessionEncryptionKey = null;

        var taskMap = {};

        // https://stackoverflow.com/questions/58325771/how-to-generate-random-hex-string-in-javascript
        function generateRandomHexString(numBytes) {
            const bytes = crypto.getRandomValues(new Uint8Array(numBytes));
            const array = Array.from(bytes);
            const hexPairs = array.map(b => b.toString(16).padStart(2, '0'));
            return hexPairs.join('');
        }

        function encryptMessage(message, key, iv) {
            var encryptResult = CryptoJS.AES.encrypt(message, key, {
                iv: iv
            });
            return encryptResult.toString();
        }

        function decryptMessage(message, key, iv) {
            var decryptResult = CryptoJS.AES.decrypt(message, key, {
                iv: iv
            });
            return decryptResult.toString(CryptoJS.enc.Utf8);
        }

        function setSessionToken(sessionToken) {
            Cookies.set('sessionToken', sessionToken);
        }

        function setSessionWalletAddress(walletAddress) {
            localStorage.setItem('walletAddress', walletAddress);
        }

        function getSessionWalletAddress() {
            return localStorage.getItem('walletAddress');
        }

        function setSessionEncryptionKey(encryptionKey) {
            localStorage.setItem('encryptionKey', encryptionKey.toString());

            // test that encryption key is stored correctly
            if (!checkUint8ArraysEqual(encryptionKey, getSessionEncryptionKey())) {
                throw 'Encryption key error';
            }
        }

        function getSessionEncryptionKey() {
            return new Uint8Array(localStorage.getItem('encryptionKey').split(','));
        }

        // CryptoJS.AES requires CryptoJS.enc.Hex.parse for custom encryption key
        function getFormattedSessionEncryptionKey() {
            var sessionEncryptionKey = getSessionEncryptionKey();
            var key = CryptoJS.enc.Hex.parse(convertUint8ArrayToHexString(sessionEncryptionKey));

            // sanity check key
            var calculatedKey = convertHexStringToUint8Array(CryptoJS.enc.Hex.stringify(key));
            if (!checkUint8ArraysEqual(calculatedKey, sessionEncryptionKey)) {
                throw 'Encryption key error';
            }

            return key;
        }

        // https://stackoverflow.com/questions/38987784/how-to-convert-a-hexadecimal-string-to-uint8array-and-back-in-javascript
        const convertHexStringToUint8Array = (hexString) =>
            Uint8Array.from(hexString.match(/.{1,2}/g).map((byte) => parseInt(byte, 16)));
        const convertUint8ArrayToHexString = (bytes) =>
            bytes.reduce((str, byte) => str + byte.toString(16).padStart(2, '0'), '');

        function checkUint8ArraysEqual(array1, array2) {
            if (!(array1 instanceof Uint8Array) || !(array2 instanceof Uint8Array)) {
                return false;
            }
            if (array1.length !== array2.length) {
                return false;
            }
            for (var i = 0; i < array1.length; i++) {
                if (array1[i] !== array2[i]) {
                    return false;
                }
            }
            return true;
        }

        async function connect() {
            if (window.ethereum) {
                if (getSessionWalletAddress() && getSessionEncryptionKey()) {
                    alert('already connected');
                    // return;
                }

                await window.ethereum.request({ method: "eth_requestAccounts" });
                window.web3 = new Web3(window.ethereum);
                const account = web3.eth.accounts;
                //Get the current MetaMask selected/active wallet
                const walletAddress = account.givenProvider.selectedAddress;
                console.log(`Wallet: ${walletAddress}`);

                setSessionWalletAddress(walletAddress);

                // TODO: normalize wallet address (e.g. lowercase wallet address)

                var getUserNonceResult = await getUserNonce(walletAddress);
                console.log('getUserNonceResult:');
                console.log(getUserNonceResult);

                if (!getUserNonceResult.AuthenticationNonce) {
                    var createUserResult = await createUser(walletAddress);
                    console.log('createUserResult:');
                    console.log(createUserResult);

                    getUserNonceResult = await getUserNonce(walletAddress);
                }

                const authenticationNonce = getUserNonceResult.AuthenticationNonce;

                const signature = await web3.eth.personal.sign("Verify wallet ownership for TodoTasks.xyz\nNonce: " + authenticationNonce, walletAddress);
                console.log('Signature: ' + signature);

                var authenticateUserResult = await authenticateUser(walletAddress, signature);
                console.log('authenticateUserResult:');
                console.log(authenticateUserResult);

                const sessionToken = authenticateUserResult.sessionToken;

                setSessionToken(sessionToken);

                // TODO: store signature in cookie

                var getUserResult = await getUser(walletAddress);
                console.log('getUserResult:');
                console.log(getUserResult);

                const encryptionSalt = getUserResult.EncryptionSalt;

                if (!encryptionSalt) {
                    throw 'Encryption salt not found';
                }

                var encryptionSignature = await web3.eth.personal.sign("Generate encryption keys\nSalt: " + encryptionSalt, walletAddress);
                console.log('encryptionSignature: ' + encryptionSignature);

                // sanity check encryption signature length
                if (encryptionSignature.length < 10) {
                    throw 'Encryption signature error';
                }

                // TODO: get salt from database
                var hashResult = await argon2.hash({ pass: encryptionSignature, salt: 'default_salt', hashLen: 32 });
                var hashHex = hashResult.hashHex;
                var hash = hashResult.hash;
                console.log(hashResult);
                console.log(hashHex);

                // sanity check encryption hash
                if (!(hash instanceof Uint8Array) || hash.length != 32) {
                    throw 'Encryption key error';
                }

                const masterSecret = hash; // Uint8Array of arbitrary length
                const hashMethod = 'SHA-256';
                const length = 32; // derived key length
                const info = ''; // information specified in rfc5869
                const salt = new Uint8Array([1]); // Uint8Array of arbitrary length
                // In the future, can use other salt values to derive keys for other purposes

                var derivedKey = await HKDF.compute(masterSecret, hashMethod, length, info, salt);
                console.log('derivedKey:');
                console.log(derivedKey);

                const encryptionKey = derivedKey.key;

                // sanity check encryption key
                if (!(encryptionKey instanceof Uint8Array) || encryptionKey.length != 32) {
                    throw 'Encryption key error';
                }

                console.log('encryptionKey');
                console.log(encryptionKey);

                setSessionEncryptionKey(encryptionKey);

                console.log('encryptionKey to string');
                console.log(encryptionKey.toString());

                console.log('encryptionKey to string back to array');
                console.log(new Uint8Array(encryptionKey.toString().split(',')));

                console.log('getSessionEncryptionKey()');
                console.log(getSessionEncryptionKey());

                // TODO: iv should be stored in message and generated randomly
                // IV size should be 16 bytes (128 bits)
                var iv = CryptoJS.enc.Hex.parse(generateRandomHexString(16));
                console.log('iv');
                console.log(iv);

                // Encrypt
                var encryptResult = CryptoJS.AES.encrypt('my message', encryptionKey, {
                    iv: iv
                });
                var ciphertext = encryptResult.toString();
                console.log('encryptResult: ');
                console.log(encryptResult);
                console.log('ciphertext: ' + ciphertext);

                var decryptedText = CryptoJS.AES.decrypt(ciphertext, encryptionKey, {
                    iv: iv
                }).toString(CryptoJS.enc.Utf8);

                console.log('decryptedText: ' + decryptedText);
            } else {
                alert('No Ethereum wallet detected');
                console.log("No wallet");
            }
        }

        async function createUser(userId) {
            return new Promise(resolve => {
                $.post('/api/createuser', {
                    userId: userId
                }, function (result) {
                    console.log(result);

                    resolve(result);
                });
            });
        }

        async function getUser(userId) {
            return new Promise(resolve => {
                $.get('/api/getuser', {
                    userId: userId
                }, function (result) {
                    console.log(result);

                    resolve(result);
                });
            });
        }

        async function getUserNonce(userId) {
            return new Promise(resolve => {
                $.get('/api/getusernonce', {
                    userId: userId
                }, function (result) {
                    console.log(result);

                    resolve(result);
                });
            });
        }

        async function authenticateUser(userId, signature) {
            return new Promise(resolve => {
                $.post('/api/authenticateuser', {
                    userId: userId,
                    signature: signature
                }, function (result) {
                    console.log(result);

                    resolve(result);
                });
            });
        }

        function addTask(taskTitle, callback) {
            // TODO: remove console.log of encryption keys

            var data = JSON.stringify({
                title: taskTitle
            });
            console.log('enc key');
            console.log(getSessionEncryptionKey());

            var key = getFormattedSessionEncryptionKey();
            var iv = generateRandomHexString(16);
            var encryptedData = encryptMessage(data, key, CryptoJS.enc.Hex.parse(iv));
            $.post('/api/createtask', {
                userId: getSessionWalletAddress(), // TODO: server side should normalize wallet address (e.g. lowercase wallet address)
                encryptionIV: iv,
                encryptedData: encryptedData
            }, function (result) {
                console.log('addTask:');
                console.log(result);

                // TODO: return error message in callback?

                callback(null, result);
            });
        }

        function updateTaskTitle(taskId, taskTitle, callback) {
            var data = JSON.stringify({
                title: taskTitle
            });

            var key = getFormattedSessionEncryptionKey();

            console.log(taskId);
            console.log(taskMap[taskId]);
            var iv = taskMap[taskId].EncryptionIV;
            var encryptedData = encryptMessage(data, key, CryptoJS.enc.Hex.parse(iv));

            updateTask({
                taskId: taskId,
                encryptedData: encryptedData
            }, callback);
        }

        function updateTaskCompletion(taskId, isCompleted, callback) {
            updateTask({
                taskId: taskId,
                isCompleted: isCompleted
            }, callback);
        }

        function updateTask(data, callback) {
            $.post('/api/updatetask', {
                userId: getSessionWalletAddress(),
                taskId: data.taskId,
                isCompleted: data.isCompleted,
                encryptedData: data.encryptedData
            }, function (result) {
                console.log(result);

                callback(null, result);
            });
        }

        function getTasks(callback) {
            $.get('/api/gettasks', {
                userId: getSessionWalletAddress(), // TODO: server side should normalize wallet address (e.g. lowercase wallet address)
            }, function (result) {
                console.log(result);

                // TODO: return error message in callback?

                callback(null, result);
            });
        }

        function createTaskRow(task, isCompleted) {
            var row = $('<tr></tr>');

            var key = getFormattedSessionEncryptionKey();
            var iv = task.EncryptionIV;
            var encryptedData = task.EncryptedData;
            var taskId = task.TaskId;

            var decryptedData = decryptMessage(encryptedData, key, CryptoJS.enc.Hex.parse(iv));

            console.log(decryptedData);

            var data = JSON.parse(decryptedData);

            var checkbox = $('<input class="form-check-input" type="checkbox" value=""/>')
                .prop('checked', isCompleted)
                .addClass('task_checkbox')
                .attr('data-task-id', taskId);

            var cell1 = $('<td></td>').append(checkbox);
            var cell2 = $('<td></td>').addClass('task_title_cell').text(data.title);
            cell2.attr('data-task-id', taskId);

            row.append(cell1);
            row.append(cell2);

            row.addClass('task_row');
            row.attr('data-task-id', taskId);

            if (isCompleted) {
                row.find('.task_title_cell').addClass('task_strikethrough');
            }

            return row;
        }

        $(document).ready(function () {
            $(document).on('change', '.task_checkbox', function () {
                const taskId = $(this).attr("data-task-id");
                const taskIsChecked = this.checked;
                updateTaskCompletion(taskId, taskIsChecked, function (err, result) {
                    console.log(result);

                    if (taskIsChecked) {
                        var row = $('.task_row[data-task-id="' + taskId + '"]');
                        row.remove();

                        row.find('.task_title_cell').addClass('task_strikethrough');

                        $('#completed_tasks_tbody').prepend(row);
                    } else {
                        var row = $('.task_row[data-task-id="' + taskId + '"]');
                        row.remove();

                        row.find('.task_title_cell').removeClass('task_strikethrough');

                        $('#open_tasks_tbody').prepend(row);
                    }
                });
            });

            $(document).on('click', '.task_title_cell', function () {
                $('#edit_task_title_input').val($(this).text());
                var taskId = $(this).attr('data-task-id');
                $('#edit_task_title_input').attr('data-task-id', taskId);
                $("#editTaskModal").modal('show');
            });

            $('#save_task_button').click(function () {
                var taskTitle = $('#task_title_input').val().trim();
                addTask(taskTitle, function (err, result) {
                    // TODO: handle err
                    var row = createTaskRow(result.task, false);

                    taskMap[result.task.TaskId] = result.task;

                    $('#open_tasks_tbody').prepend(row);
                });
            });

            $('#task_title_input').keypress(function (e) {
                if (e.which == 13) {
                    $('#save_task_button').click();
                }
            });

            $('#edit_save_task_button').click(function () {
                var taskId = $('#edit_task_title_input').attr('data-task-id');
                var taskTitle = $('#edit_task_title_input').val().trim();
                updateTaskTitle(taskId, taskTitle, function (err, result) {
                    $('.task_title_cell[data-task-id="' + taskId + '"]').text(taskTitle);
                });
            });

            $('#edit_task_title_input').keypress(function (e) {
                if (e.which == 13) {
                    $('#edit_save_task_button').click();
                }
            });

            $('#addTaskModal').on('show.bs.modal', function (e) {
                $('#task_title_input').val('');
            });

            $('#addTaskModal').on('shown.bs.modal', function (e) {
                $('#task_title_input').focus();
            });

            $('#editTaskModal').on('shown.bs.modal', function (e) {
                $('#edit_task_title_input').focus();
            });

            getTasks(function (err, result) {
                const tasks = result.tasks;

                tasks.sort(function (a, b) {
                    return Number(b.CreationTime) - Number(a.CreationTime);
                });

                for (var i = 0; i < tasks.length; i++) {
                    var task = tasks[i];

                    var isCompleted = task.IsCompleted;
                    var row = createTaskRow(task, isCompleted);

                    if (isCompleted) {
                        $('#completed_tasks_tbody').append(row);
                    } else {
                        $('#open_tasks_tbody').append(row);
                    }

                    taskMap[task.TaskId] = task;

                    console.log(task);
                }

                $('#open_tasks_tbody').sortable();

                /*
                for (var i = 0; i < result.length; i++) {
                    var encryptedData = result[i].EncryptedData;
                    console.log('encryptedData');
                    console.log(encryptedData);

                    var key = getFormattedSessionEncryptionKey();

                    console.log('key!');
                    console.log(key);

                    var decryptedData = decryptMessage(encryptedData, key, CryptoJS.enc.Hex.parse('0000000000000000'));

                    console.log(decryptedData);
                }
                */
            });
        });

        // TODO: expand input height to show whole task title

        // TODO: save task on enter

        // TODO: add title, body

        // TODO: when clicking outside the modal, show are you sure you want to discard changes text
    </script>

    <div class="container">

        <h2 class="mt-3">
            TodoTasks.xyz
        </h2>

        <p>
            <button type="button" class="btn btn-primary" onclick="connect();">Connect Wallet</button>
        </p>

        <p>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                Add Task
            </button>
        </p>

        <!-- Modal -->
        <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Add Task</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input id="task_title_input" type="text" autocomplete="off" class="form-control" />
                    </div>
                    <div class="modal-footer">
                        <button id="save_task_button" type="button" class="btn btn-primary"
                            data-bs-dismiss="modal">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Edit Task</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input id="edit_task_title_input" type="text" autocomplete="off" class="form-control" />
                    </div>
                    <div class="modal-footer">
                        <button id="edit_save_task_button" type="button" class="btn btn-primary"
                            data-bs-dismiss="modal">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <table id="open_tasks_table">
                <tbody id="open_tasks_tbody"></tbody>
            </table>

            <div class="accordion accordion-flush" id="accordionFlushExample"
                style="border-top: 1px solid rgb(216, 216, 216); margin-top: 15px;">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingOne">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne"
                            style="">
                            Completed Tasks
                        </button>
                    </h2>
                    <div id="flush-collapseOne" class="accordion-collapse collapse" aria-labelledby="flush-headingOne"
                        data-bs-parent="#accordionFlushExample">

                        <table id="completed_tasks_table">
                            <tbody id="completed_tasks_tbody"></tbody>
                        </table>

                        <div class="accordion-body"></div>
                    </div>
                </div>
            </div>
        </div>

        <p>
            TodoTasks.xyz is a web3 end-to-end encrypted task manager. It can be used
            for todos and quick notes.
        </p>

        <p>
            To sign in, connect with your Ethereum wallet and sign two messages for
            (1) verifying wallet ownership, and (2) generating encryption keys.
        </p>

        <p>
            All tasks are end-to-end encrypted and stored in AWS.
        </p>

        <p>
            TodoTasks.xyz is <a href="https://github.com/zoan37/web3-todo-tasks" target="_blank">open source on
                GitHub</a>. Made by <a href="https://twitter.com/zoan37" target="_blank">zoan.eth</a>.
        </p>

    </div>

</body>

</html>